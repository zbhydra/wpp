# 004. 桌面端架构

## 概述

**Electron + Vue 3** 架构，单窗口多视图设计，通过 BrowserView 管理多个独立 WhatsApp 会话。

---

## 技术栈

| 技术 | 用途 |
|------|------|
| Electron 39 | 桌面框架 |
| Vue 3.5 | UI 框架 |
| Element Plus 2.13 | 组件库 |
| TypeScript 5.7 | 类型系统 |
| Vite 7.3 | 构建工具 |

---

## 进程架构

```
主进程 (BrowserViewManager + AccountManager + EventService)
    ↓ IPC
渲染进程 (Vue 3) | WhatsApp Views | TabBar View
```

---

## 目录结构

```
desktop_old/src/
├── main/              # 主进程
│   ├── main.ts       # 入口
│   ├── BrowserViewManager.ts
│   ├── whatsapp/     # WhatsApp 管理
│   ├── base/         # 基础抽象
│   ├── services/     # EventService
│   └── ipc/          # IPC 处理
├── renderer/         # 渲染进程 (Vue 3)
│   ├── views/        # 页面
│   ├── components/   # 组件
│   ├── api/          # API 层
│   └── router/       # 路由
├── preload/          # Preload 脚本
│   ├── index.ts      # 主 preload
│   └── whatsapp-preload/
└── shared/           # 共享代码
    └── ipc/channels.ts
```

---

## 核心模块

### BrowserViewManager

**位置**: `desktop_old/src/main/BrowserViewManager.ts` (699 行)

**职责**: 管理所有 WebContentsView，视图切换

**三种视图**:
- **TabBar**: 固定顶部，内联 HTML，标签切换
- **Admin**: Vue 应用，管理界面
- **WhatsApp**: 动态添加，独立会话

### WhatsAppAccountManager

**位置**: `desktop_old/src/main/whatsapp/WhatsAppAccountManager.ts` (253 行)

**职责**: 账号 CRUD，生命周期管理

**startAccount 流程**: 检查状态 → 注册回调 → 创建视图 → 加载 WA Web → 通知 Renderer → 更新状态

### WhatsAppBrowserView

**位置**: `desktop_old/src/main/whatsapp/WhatsAppBrowserView.ts` (325 行)

**职责**: 单个 WhatsApp 视图封装

**特性**: 独立 partition (`persist:wa-{accountId}`)，CSP 修改，IPC 桥接

### EventService

**位置**: `desktop_old/src/main/services/EventService.ts`

**职责**: 中央事件总线，跨进程消息转发

**方法**: forwardWhatsAppEventToRenderer, forwardToWhatsAppView, notifyTabCreated/Closed/Switched

---

## IPC 通信

**通道定义**: `desktop_old/src/shared/ipc/channels.ts`

**三类通道**:

1. **WHATSAPP_WINDOW_CHANNELS** (WhatsApp View ↔ Main)
   - READY, LOGIN, LOGOUT, MESSAGE_RECEIVED (事件上报)
   - COMMAND (命令下发)

2. **RENDERER_CHANNELS** (Renderer ↔ Main)
   - getAccounts, startAccount, stopAccount (invoke)
   - accounts:update, message:received (广播)

3. **TAB_CHANNELS** (TabBar ↔ Main)
   - switch, close, reorder
   - created, closed, switched (事件)

**注册位置**: `desktop_old/src/main/ipc/index.ts`

---

## Preload 脚本

### 主 Preload

**位置**: `desktop_old/src/preload/index.ts`

**暴露 API** (contextBridge):
- whatsapp: 账号管理 + 事件监听
- messageHistory: 消息历史
- tabs: 标签页操作

### WhatsApp Preload

**位置**: `desktop_old/src/preload/whatsapp-preload/index.ts`

**初始化**: 隐藏 Electron 特征 → 注入 WA-JS → 设置命令监听 → 暴露 API

---

## 渲染进程

### 路由

**位置**: `desktop_old/src/renderer/router/index.ts`

**路由**: /login, /register, / (AdminLayout → dashboard, whatsapp/accounts)

### 核心组件

**AccountManager.vue**: 账号列表，启动/停止/删除/重命名，监听状态更新

---

## 启动流程

```
app.whenReady → registerWaAssetsProtocol → createWindow → BrowserViewManager 初始化 → 创建 TabBar/Admin 视图 → WhatsAppAccountManager 初始化 → setupIPCHandlers → 加载 Vue
```

---

## 关键文件

| 优先级 | 文件 | 职责 |
|-------|------|------|
| 1 | `desktop_old/src/main/main.ts` | 应用入口 |
| 2 | `desktop_old/src/main/BrowserViewManager.ts` | 视图管理 |
| 3 | `desktop_old/src/main/whatsapp/WhatsAppAccountManager.ts` | 账号管理 |
| 4 | `desktop_old/src/main/whatsapp/WhatsAppBrowserView.ts` | WA 视图封装 |
| 5 | `desktop_old/src/main/services/EventService.ts` | 事件转发 |
| 6 | `desktop_old/src/shared/ipc/channels.ts` | IPC 通道 |
| 7 | `desktop_old/src/preload/index.ts` | 主 preload |
| 8 | `desktop_old/src/renderer/views/whatsapp/AccountManager.vue` | 账号 UI |
| 9 | `desktop_old/src/main/ipc/index.ts` | IPC handlers |
| 10 | `desktop_old/src/renderer/router/index.ts` | 路由配置 |

---

## 相关文档

- [001. 基础架构](./001.basic-architecture.md)
- [002. 浏览器通信](./002.browser-communication.md)
