# 002. 浏览器通信

## 概述

使用 **@wppconnect-team/wppconnect** 库实现与 WhatsApp Web 通信，核心机制是在 WhatsApp Web 页面注入 JavaScript (WA-JS) 实现自动化。

---

## 核心组件

### @wppconnect-team/wppconnect

**版本**: ^1.37.8

**用途**:
- 提供 `wapi.js` (高级 API 封装)
- 依赖 `@wppconnect/wa-js` (核心 WPP 库)

**实际使用**: 仅使用 lib/wapi/wapi.js 文件，主要使用 @wppconnect/wa-js

### WA-JS 注入流程

```
WhatsApp Web 加载 → preload 执行 → 隐藏 Electron 特征 → 注入 wa.js/wapi.js → 等待 WPP 就绪 → 设置事件监听 → 通知 READY
```

---

## 关键文件

| 文件 | 功能 |
|------|------|
| `desktop_old/src/main/ipc/handlers/wa-js.ts` | 通过 IPC 读取 wa.js/wapi.js |
| `desktop_old/src/preload/whatsapp-preload/injectors/wa-js-injector.ts` | 注入 WA-JS |
| `desktop_old/src/preload/whatsapp-preload/events/whatsapp-event-listener.ts` | 事件监听 |
| `desktop_old/src/preload/whatsapp-preload/commands/command-handler.ts` | 命令处理 |
| `desktop_old/src/main/whatsapp/WhatsAppBrowserView.ts` | CSP 配置 |
| `desktop_old/src/main/main.ts` | wapp-assets 协议注册 |

---

## CSP 绕过

### 注入方式

**位置**: `desktop_old/src/preload/whatsapp-preload/injectors/wa-js-injector.ts`

**技巧**:
1. 通过 IPC 从主进程读取文件内容
2. 使用 `webFrame.executeJavaScript()` 在 Isolated World 执行
3. 修改 CSP header 允许 `wapp-assets:` 协议

### CSP 配置

**位置**: `desktop_old/src/main/whatsapp/WhatsAppBrowserView.ts`

**修改目的**:
- 允许加载 `wapp-assets:` 协议脚本
- 允许 WebSocket (WSS) 连接
- 允许执行内联脚本

---

## 事件监听

**位置**: `desktop_old/src/preload/whatsapp-preload/events/whatsapp-event-listener.ts`

**监听事件**:
- `conn.authenticated` - 登录成功
- `conn.disconnected` - 登出
- `chat.new_message` - 新消息

**事件桥接**: 页面上下文 (CustomEvent) → Preload 上下文 → IPC

---

## 命令处理

**位置**: `desktop_old/src/preload/whatsapp-preload/commands/command-handler.ts`

**流程**:
1. 监听 `WHATSAPP_WINDOW_CHANNELS.COMMAND`
2. 验证 accountId 匹配
3. 调用对应 command handler
4. 在页面上下文执行 WPP API

**消息发送示例**: `desktop_old/src/preload/whatsapp-preload/commands/handlers/send-message.ts`

---

## WPP API

### 核心 API

```javascript
// 连接状态
WPP.conn.isAuthenticated()
WPP.conn.isConnected()

// 发送消息
WPP.chat.sendTextMessage(jid, message)
WPP.chat.sendFile(jid, file)

// 联系人和聊天
WAPI.getAllContacts()
WAPI.getAllChats()
WAPI.getChatById(jid)
```

### 事件监听

```javascript
WPP.on('conn.authenticated', callback)
WPP.on('conn.disconnected', callback)
WPP.on('chat.new_message', callback)
WPP.on('msg.sent', callback)
```

---

## 消息流向

### 发送消息

```
Renderer UI → IPC → Main → EventService → ViewManager → WhatsAppBrowserView → Preload → WPP.chat.sendTextMessage() → 事件回调 → UI 更新
```

### 接收消息

```
WhatsApp Web → WPP.on('chat.new_message') → CustomEvent → Preload → IPC → Main → EventService → Renderer → UI 更新
```

---

## 会话隔离

**机制**: 每个 WhatsApp 账号使用独立 `partition: persist:wa-{accountId}`

**隔离内容**: Cookies, LocalStorage, SessionStorage, IndexedDB, Cache Storage

**优势**: 完全独立的登录状态，互不干扰，可同时运行多账号

---

## 反检测

**位置**: `desktop_old/src/preload/whatsapp-preload/security/anti-detection.ts`

**措施**:
- 修改 User-Agent
- 添加 chrome 对象
- 删除 process 对象
- 修改 navigator.platform

---

## 相关文档

- [001. 基础架构](./001.basic-architecture.md)
- [004. 桌面端架构](./004.desktop-architecture.md)
