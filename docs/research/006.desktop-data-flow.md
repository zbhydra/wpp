# 006. 桌面端数据流与状态管理

## 概述

说明桌面端的数据流向、状态管理机制和事件通信。

---

## 账号状态

### 状态定义

```
Stopped → Starting → QR → Ready → LoggedIn ←→ LoggedOut
    ↑                                    ↓
    └────────────────────────────────────┘
```

**状态说明**:
- **Stopped**: 已停止
- **Starting**: 启动中
- **QR**: 等待扫码
- **Ready**: WA-JS 就绪
- **LoggedIn**: 已登录
- **LoggedOut**: 已登出

### 状态存储

**位置**: `sessions.json` + `tokens/{id}.json`

**管理者**: WhatsAppSessionManager (`desktop_old/src/main/whatsapp/WhatsAppSessionManager.ts`)

**数据结构**:
```typescript
interface SessionData {
  id: string;
  name: string;
  status: AccountStatus;
  tokens?: any;
  createdAt: number;
  updatedAt: number;
}
```

### 状态同步

**触发时机**:
- 账号启动/停止
- WhatsApp 登录/登出
- WA-JS 就绪/错误

**同步流程**:
```
Main Process (WhatsAppAccountManager)
    ↓
1. 更新内部状态
    ↓
2. 持久化到 SessionManager
    ↓
3. EventService 广播
    ↓
Renderer Process 更新 UI
```

---

## 消息数据流

### 发送消息

```
用户操作 (UI)
    ↓
electronApi.whatsapp.sendMessage()
    ↓
IPC: whatsapp:sendCommand
    ↓
Main: EventService.forwardToWhatsAppView()
    ↓
WhatsAppViewManager.sendCommand()
    ↓
WhatsAppBrowserView.sendCommand()
    ↓
IPC: whatsapp_window:command
    ↓
Preload: command-handler.ts
    ↓
WPP.chat.sendTextMessage()
    ↓
WhatsApp Web 发送
    ↓
事件: wa:message:sent
    ↓
IPC: whatsapp_window:message_sent
    ↓
Main: 回调处理
    ↓
EventService.forwardWhatsAppEventToRenderer()
    ↓
Renderer: onMessageSent
    ↓
UI 更新
```

### 接收消息

```
WhatsApp Web 收到新消息
    ↓
WPP.on('chat.new_message')
    ↓
Preload: 事件监听器
    ↓
CustomEvent: wa:message:received
    ↓
IPC: whatsapp_window:message_received
    ↓
Main: callbacks.onMessageReceived()
    ↓
WhatsAppBrowserView.messenger.sendEvent()
    ↓
EventService.forwardWhatsAppEventToRenderer()
    ↓
Renderer: onMessageReceived()
    ↓
UI 更新显示新消息
```

---

## IPC 事件流

### 事件分类

| 类型 | 通道 | 方向 | 说明 |
|------|------|------|------|
| 账号状态更新 | `whatsapp:accounts:update` | Main → Renderer | 账号列表变化 |
| 标签创建 | `tab:created` | Main → Renderer | 新标签创建 |
| 标签关闭 | `tab:closed` | Main → Renderer | 标签关闭 |
| 标签切换 | `tab:switched` | Main → Renderer | 标签切换 |
| 消息接收 | `whatsapp:message:received` | Main → Renderer | 新消息 |
| WA 就绪 | `whatsapp_window:ready:{id}` | View → Main | WA-JS 加载完成 |
| WA 登录 | `whatsapp_window:login:{id}` | View → Main | 登录成功 |
| WA 登出 | `whatsapp_window:logout:{id}` | View → Main | 登出 |

### EventService

**位置**: `desktop_old/src/main/services/EventService.ts`

**职责**: 中央事件总线，跨进程消息转发

**核心方法**:
```typescript
// View → Main → Renderer
forwardWhatsAppEventToRenderer(channel, payload)

// Renderer → Main → View
forwardToWhatsAppView(accountId, command, data)

// 通知标签变更
notifyTabCreated(accountId, name)
notifyTabClosed(accountId)
notifyTabSwitched(accountId)
```

---

## 消息历史

### 存储位置

- **临时**: Renderer 内存 (Vue reactive state)
- **持久**: Main Process (JSON 文件)

### 同步流程

**发送消息后**:
1. 调用 sendMessage API
2. 添加到本地历史 (临时)
3. 持久化到存储

**接收消息时**:
1. 监听 `whatsapp:message:received` 事件
2. 添加到本地历史
3. 更新 UI 显示

---

## 错误处理

### 错误类型

```typescript
enum AccountErrorType {
  AlreadyRunning = 'already_running',
  NotFound = 'not_found',
  LoadFailed = 'load_failed',
  AuthenticationFailed = 'auth_failed'
}
```

### 处理流程

```typescript
try {
  await accountManager.startAccount(accountId);
} catch (error) {
  if (error instanceof AccountError) {
    // 1. 提示用户
    ElMessage.error(error.message);
    // 2. 更新状态
    updateAccountStatus(accountId, AccountStatus.Stopped);
  } else {
    logger.error('Unknown error:', error);
  }
}
```

---

## 性能优化

### 懒加载

**机制**: 仅加载当前激活的视图，移除其他视图

**实现**: `BrowserViewManager.setActiveView()`

**效果**: 减少内存占用，提升性能

### 状态缓存

**本地状态**: Vue reactive state

**持久状态**: SessionManager (文件系统)

**同步策略**: 状态变化时实时同步

---

## 相关文档

- [001. 基础架构](./001.basic-architecture.md)
- [002. 浏览器通信](./002.browser-communication.md)
- [004. 桌面端架构](./004.desktop-architecture.md)
