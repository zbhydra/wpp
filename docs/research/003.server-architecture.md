# 003. 服务器端架构

## 概述

**FastAPI + SQLAlchemy + MySQL + Redis** 异步架构，提供用户认证、订单管理、支付集成。

---

## 技术栈

| 技术 | 用途 |
|------|------|
| FastAPI 0.124+ | Web 框架 |
| SQLAlchemy 2.0+ | 异步 ORM |
| MySQL | 主数据库 |
| Redis 7.1+ | 缓存/会话 |
| Uvicorn | ASGI 服务器 |
| PyJWT | JWT 认证 |

---

## 目录结构

```
server/src/app/
├── main.py              # 入口
├── core/                # 配置 (config, database, redis)
├── api/                 # 路由 (client/, system/)
├── models/              # 数据模型
├── services/            # 业务逻辑
├── middleware/          # 中间件
├── schemas/             # Pydantic 模型
├── utils/               # 工具
└── i18n/                # 国际化
```

---

## 启动流程

**入口**: `server/src/app/main.py`

**顺序**: 加载配置 → 创建 app → 注册中间件 → 注册路由 → 初始化数据库 → 启动 Uvicorn

**中间件顺序** (洋葱模型):
1. RequestLogging (最外层)
2. CrossOrigin
3. ErrorHandling (最内层)

---

## 核心模块

### 配置管理

**位置**: `server/src/app/core/config.py`

**作用**: 从 config.yaml 加载配置，Pydantic Settings 类型验证

**配置项**: app, database, redis, auth, smtp

### 数据库连接

**位置**: `server/src/app/core/database.py`

**特性**:
- 单例 Engine
- 连接池 (20+40)
- 异步上下文管理器，自动 commit/rollback

### 中间件

| 中间件 | 功能 |
|--------|------|
| RequestLogging | 生成 request_id，记录处理时间 |
| CrossOrigin | CORS 处理 |
| ErrorHandling | 捕获异常，i18n 翻译 |

### 服务层

**BaseService** - 泛型 CRUD 基类

**UserAuthService** - 认证服务:
- 用户认证 (登录/注册)
- Token 生成 (Access 24h, Refresh 7天)
- 会话管理

### 数据模型

**UserModel** (`server/src/app/models/user_model.py`):
- 字段: id, email, password_hash, nickname, login_count, last_login_at, failed_login_attempts, locked_until
- 方法: is_locked(), lock()

**OrderModel** (`server/src/app/models/order_model.py`):
- 状态机: PENDING → PAID → EXPIRED/CANCELLED

---

## API 路由

### 认证 (`/api/client/auth`)

| 端点 | 功能 |
|------|------|
| POST /register | 注册 |
| POST /login | 登录 |
| POST /logout | 登出 |
| POST /refresh | 刷新 Token |
| GET /me | 获取当前用户 |
| POST /send-email-code | 发送验证码 |
| POST /email-verify-login | 验证码登录 |

### 订单 (`/api/client/order`)

| 端点 | 功能 |
|------|------|
| POST /create | 创建订单 |
| GET /status/{order_no} | 查询状态 |
| GET /list | 订单列表 |

### 系统 (`/api/system`)

| 端点 | 功能 |
|------|------|
| GET /health | 健康检查 |

---

## 认证机制

### JWT Token

**Access Token**: 24h 有效期
**Refresh Token**: 7天 有效期

### Token 存储 (Redis ZSet)

```
access_token:{user_id} → [md5(token)=expires_at, ...]
refresh_token:{user_id} → [md5(token)=expires_at, ...]
refresh_token_old:{user_id} → [md5(old_token)=expires_at+30s]  # 宽限期
```

### Token 轮换

1. 验证 Refresh Token
2. 生成新 Token
3. 旧 Token 移到 old (宽限期 30s)
4. 存储新 Token

### 依赖注入

**位置**: `server/src/app/api/user_dependencies.py`

**UserContext**: user_id, token, device_id, language, ip

**get_current_user**: 解析 JWT → 验证 Redis → 返回 UserContext

---

## 错误处理

**错误代码**: `server/src/app/i18n/common_code.py`

**分类**:
- SUCCESS (10000)
- VALIDATION_ERROR (10001)
- USER_NOT_FOUND (10104)
- AUTH_INVALID_CREDENTIALS (10006)
- ORDER_NOT_FOUND (20001)

**响应格式**:
```json
{"code": 10000, "data": {...}, "msg": "success"}
```

---

## 数据库迁移

**位置**: `server/src/app/init/sync_database_schema.py`

**功能**: 对比模型与实际结构，支持自动创建表、添加列

**使用**:
```bash
uv run python src/app/init/sync_database_schema.py
uv run python src/app/init/sync_database_schema.py --yes  # 自动确认
```

---

## 关键文件

| 优先级 | 文件 | 职责 |
|-------|------|------|
| 1 | `server/src/app/main.py` | 应用入口 |
| 2 | `server/src/app/core/config.py` | 配置管理 |
| 3 | `server/src/app/core/database.py` | 数据库连接 |
| 4 | `server/src/app/middleware/error_handling.py` | 异常处理 |
| 5 | `server/src/app/api/user_dependencies.py` | 认证依赖 |
| 6 | `server/src/app/services/user_auth_service.py` | 认证服务 |
| 7 | `server/src/app/api/client/auth_client.py` | 认证 API |
| 8 | `server/src/app/models/user_model.py` | 用户模型 |
| 9 | `server/src/app/utils/jwt.py` | JWT 工具 |
| 10 | `server/src/app/core/redis.py` | Redis 连接 |

---

## 相关文档

- [001. 基础架构](./001.basic-architecture.md)
- [005. 部署与配置](./005.deployment-and-config.md)
