# 005. 部署与配置

## 概述

项目采用 **GitHub Actions + SSH + Supervisor** 的部署架构。

**核心组件**:
- GitHub Actions (CI/CD)
- Supervisor (进程守护)
- Nginx (反向代理)
- FastAPI + Uvicorn (应用服务)
- MySQL + Redis (数据存储)

---

## 目录结构

```
server/deploy/
├── init.sh, deploy.sh, rollback.sh, health_check.sh  # 部署脚本
├── supervisor/tg-download.conf                       # Supervisor 配置
├── nginx/nginx.conf                                  # Nginx 配置
└── script/deploy_init.sh, deploy_remote.sh          # 远程脚本
```

---

## 配置文件

### config.yaml

**位置**: `server/config.yaml`

**作用**: 主配置文件，包含应用、数据库、Redis、认证、SMTP 等配置

**关键配置项**:
- `app`: 应用基础信息 (名称、端口、环境)
- `database`: MySQL 连接 (连接池 20+40)
- `redis`: Redis 连接 (连接池 5000)
- `auth`: JWT 配置 (Access Token 24h, Refresh Token 7天)
- `smtp`: 邮件服务配置

### Supervisor 配置

**位置**: `server/deploy/supervisor/tg-download.conf`

**作用**: 进程守护配置，管理 FastAPI 服务

**关键设置**:
- 开机自启、崩溃自动重启
- 单进程模式 (workers=1)
- 日志轮转 (50MB × 10 备份)

### Nginx 配置

**位置**: `server/deploy/nginx/nginx.conf`

**作用**: 反向代理，将 `/tg-download/*` 转发到本地 9680 端口

---

## 部署流程

### 首次部署

```bash
# 1. 本地初始化
cd server/deploy && bash init.sh

# 2. 登录服务器配置
ssh root@服务器IP
vi /data/extension-tg-download/backend/config.yaml

# 3. 数据库迁移
cd /data/extension-tg-download/backend
uv run python src/app/init/sync_database_schema.py

# 4. 启动服务
supervisorctl start tg-download
```

### 自动部署

**触发**: 推送到 main 分支或手动触发

**流程**: 质量检查 → SSH 连接 → 备份 → 拉取代码 → 安装依赖 → 数据库迁移 → 重启 → 健康检查

### 回滚

```bash
# 查看可用备份
ls -la /data/backups/extension-tg-download/

# 回滚到指定版本
bash deploy/rollback.sh <备份路径>
```

---

## 数据库初始化

**主要文件**:

| 文件 | 功能 |
|------|------|
| `sync_database_schema.py` | 结构同步 (模型 vs 实际) |
| `init_db.py` | 基础初始化 (建库、执行 SQL) |
| `sql_executor.py` | SQL 执行工具 |
| `export_database_schema.py` | 结构导出 |

**主要表**: users, user_subscriptions, orders, payment_records, callback_logs

---

## 常用命令

### 服务管理

```bash
supervisorctl start/stop/restart/status tg-download
supervisorctl tail -f tg-download  # 实时日志
```

### 日志查看

```bash
tail -f /data/extension-tg-download/backend/log/supervisor.log
tail -f /data/extension-tg-download/backend/log/app.log
```

### 健康检查

```bash
curl http://localhost:9680/api/system/health
bash /data/extension-tg-download/backend/deploy/health_check.sh
```

---

## 注意事项

**安全**:
- SSH 密钥需妥善保管
- config.yaml 含敏感信息，不提交代码库
- 生产环境必须修改 JWT 密钥

**数据库**:
- 迁移前备份
- 先测试环境验证

**日志**:
- 定期清理旧日志
- 设置监控告警

---

## 相关文档

- [001. 基础架构](./001.basic-architecture.md)
- [003. 服务器端架构](./003.server-architecture.md)
